name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  pull-requests: write

env:
  REGION: asia-southeast1
  DEV_PROJECT: the-white-dev-481217
  PROD_PROJECT: the-white-prod-481217

jobs:
  cancel-cloud-builds:
    name: Cancel Cloud Builds
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "project_id=${{ env.PROD_PROJECT }}" >> $GITHUB_OUTPUT
            echo "filter=source.repoSource.tagName=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "project_id=${{ env.DEV_PROJECT }}" >> $GITHUB_OUTPUT
            echo "filter=source.repoSource.branchName=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ steps.env.outputs.environment == 'prod' && 'projects/570865959950/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' || 'projects/635555941174/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' }}
          service_account: github-actions-deployer@${{ steps.env.outputs.project_id }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cancel previous builds
        run: |
          FILTER="${{ steps.env.outputs.filter }}"
          COMMIT_SHA="${{ github.sha }}"
          echo "ðŸ” Looking for builds to cancel..."
          echo "   Filter: $FILTER"
          echo "   Commit: $COMMIT_SHA"

          # Get all queued/working builds first
          ALL_BUILDS=$(gcloud builds list \
            --region="${{ env.REGION }}" \
            --project="${{ steps.env.outputs.project_id }}" \
            --filter="status=WORKING OR status=QUEUED" \
            --format="json" \
            --limit=100 2>/dev/null || echo "[]")

          if [ "$ALL_BUILDS" = "[]" ] || [ -z "$ALL_BUILDS" ]; then
            echo "â„¹ï¸  No running/queued builds found"
            exit 0
          fi

          # Filter builds by branch/tag or commit SHA
          RUNNING_BUILDS=$(echo "$ALL_BUILDS" | jq -r --arg filter "$FILTER" --arg sha "$COMMIT_SHA" '
            .[] | 
            select(
              (.source.repoSource.branchName // "" | ascii_downcase) as $branch |
              (.source.repoSource.tagName // "" | ascii_downcase) as $tag |
              (.source.repoSource.commitSha // "" | ascii_downcase) as $buildSha |
              ($filter | ascii_downcase | split("=") | .[1]) as $filterValue |
              (
                ($filter | contains("branchName")) and ($branch == $filterValue) or
                ($filter | contains("tagName")) and ($tag == $filterValue) or
                ($buildSha | startswith($sha[0:7]))
              )
            ) | .id
          ' 2>/dev/null || echo "")

          if [ -z "$RUNNING_BUILDS" ]; then
            echo "â„¹ï¸  No matching builds to cancel"
            exit 0
          fi

          BUILD_COUNT=$(echo "$RUNNING_BUILDS" | grep -c . || echo "0")
          echo "Found $BUILD_COUNT build(s) to cancel"

          for BUILD_ID in $RUNNING_BUILDS; do
            if [ -n "$BUILD_ID" ] && [ "$BUILD_ID" != "null" ]; then
              echo "ðŸ›‘ Canceling build: $BUILD_ID"
              gcloud builds cancel "$BUILD_ID" \
                --region="${{ env.REGION }}" \
                --project="${{ steps.env.outputs.project_id }}" \
                --quiet 2>/dev/null || echo "âš ï¸  Failed to cancel $BUILD_ID"
            fi
          done
          echo "âœ… Canceled $BUILD_COUNT previous build(s)"

  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Generate GitHub App Token
        id: app-token
        if: github.event_name == 'pull_request'
        uses: actions/create-github-app-token@v1
        continue-on-error: true
        with:
          app-id: ${{ secrets.RELEASE_BOT_CLIENT_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}
          installation-id: ${{ secrets.RELEASE_BOT_INSTALLATION_ID }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Auto-fix formatting
        id: format
        run: |
          pnpm format || true
          if ! git diff --quiet; then
            git add -A
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit formatting fixes
        if: github.event_name == 'pull_request' && steps.format.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if ! git diff --staged --quiet; then
            git commit -m "style: auto-fix formatting issues" || exit 0
            git push origin HEAD:${{ github.head_ref }} || true
          fi

      - name: Verify formatting
        run: pnpm format:check

      - name: Run linter
        run: pnpm lint

      - name: Type check
        run: npx tsc --noEmit

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [quality]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SERVER_URL: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'https://fashion-web-dev-XXXXXX.run.app' || 'http://localhost:3000' }}
          PAYLOAD_SECRET: dummy-secret-for-build
          DATABASE_URI: dummy-uri-for-build

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [cancel-cloud-builds]
    if: github.event_name == 'push' && github.ref_type == 'tag'
    environment:
      name: ${{ startsWith(github.ref_name, 'v') && 'prod' || 'dev' }}
    steps:
      - name: Determine deployment parameters
        id: params
        run: |
          if [ "${{ startsWith(github.ref_name, 'v') }}" = "true" ]; then
            echo "project_id=${{ env.PROD_PROJECT }}" >> $GITHUB_OUTPUT
            echo "service_name=fashion-web" >> $GITHUB_OUTPUT
            echo "service_account=github-actions-deployer@${{ env.PROD_PROJECT }}.iam.gserviceaccount.com" >> $GITHUB_OUTPUT
            echo "workload_identity_provider=projects/570865959950/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider" >> $GITHUB_OUTPUT
            echo "next_public_server_url=https://fashion-web-XXXXXX.run.app" >> $GITHUB_OUTPUT
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "project_id=${{ env.DEV_PROJECT }}" >> $GITHUB_OUTPUT
            echo "service_name=fashion-web-dev" >> $GITHUB_OUTPUT
            echo "service_account=github-actions-deployer@${{ env.DEV_PROJECT }}.iam.gserviceaccount.com" >> $GITHUB_OUTPUT
            echo "workload_identity_provider=projects/635555941174/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider" >> $GITHUB_OUTPUT
            echo "next_public_server_url=https://fashion-web-dev-XXXXXX.run.app" >> $GITHUB_OUTPUT
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ steps.params.outputs.workload_identity_provider }}
          service_account: ${{ steps.params.outputs.service_account }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ format('refs/tags/{0}', github.ref_name) }}

      - name: Build and deploy to dev
        if: steps.params.outputs.environment == 'dev'
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION=$(node -p "require('./package.json').version")
          echo "ðŸ”¨ Building and deploying to dev (version: $VERSION)..."
          gcloud builds submit --config cloudbuild.yaml \
            --project "${{ steps.params.outputs.project_id }}" \
            --region="${{ env.REGION }}" \
            --substitutions _NEXT_PUBLIC_SERVER_URL="${{ steps.params.outputs.next_public_server_url }}",SHORT_SHA="$SHORT_SHA" \
            --git-source-tag="${{ github.ref_name }}"
          echo "âœ… Dev deployment complete"

          echo "ðŸ·ï¸  Tagging dev image with version $VERSION..."
          DEV_IMAGE_SHA="${{ env.REGION }}-docker.pkg.dev/${{ steps.params.outputs.project_id }}/app-images/fashion-web:$SHORT_SHA"
          DEV_IMAGE_VERSION="${{ env.REGION }}-docker.pkg.dev/${{ steps.params.outputs.project_id }}/app-images/fashion-web:$VERSION"
          gcloud artifacts docker images add-tag $DEV_IMAGE_SHA $DEV_IMAGE_VERSION \
            --project="${{ steps.params.outputs.project_id }}" \
            --quiet || echo "âš ï¸  Failed to tag image (may already exist)"
          echo "âœ… Dev image tagged: $DEV_IMAGE_VERSION"

      - name: Authenticate to dev for image copy
        if: steps.params.outputs.environment == 'prod'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/635555941174/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider
          service_account: github-actions-deployer@${{ env.DEV_PROJECT }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK for image copy
        if: steps.params.outputs.environment == 'prod'
        uses: google-github-actions/setup-gcloud@v2

      - name: Copy image from dev to prod
        if: steps.params.outputs.environment == 'prod'
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          TAG_SHA=$(git rev-parse ${{ github.ref_name }})
          SHORT_SHA=$(git rev-parse --short $TAG_SHA)
          DEV_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.DEV_PROJECT }}/app-images/fashion-web:$VERSION"
          PROD_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROD_PROJECT }}/app-images/fashion-web:$VERSION"
          PROD_IMAGE_LATEST="${{ env.REGION }}-docker.pkg.dev/${{ env.PROD_PROJECT }}/app-images/fashion-web:latest"
          PROD_IMAGE_SHA="${{ env.REGION }}-docker.pkg.dev/${{ env.PROD_PROJECT }}/app-images/fashion-web:$SHORT_SHA"

          echo "ðŸ”„ Copying image from dev to prod..."
          echo "   Version: $VERSION"
          echo "   Source: $DEV_IMAGE"
          echo "   Targets: $PROD_IMAGE, $PROD_IMAGE_LATEST, $PROD_IMAGE_SHA"

          if ! gcloud artifacts docker images describe $DEV_IMAGE --project="${{ env.DEV_PROJECT }}" --quiet 2>/dev/null; then
            echo "âŒ Error: Dev image $DEV_IMAGE not found!"
            echo "   Make sure the image was built and deployed to dev first."
            exit 1
          fi

          gcloud artifacts docker images copy $DEV_IMAGE $PROD_IMAGE \
            --project="${{ env.PROD_PROJECT }}" \
            --quiet || echo "âš ï¸  Failed to copy version tag (may already exist)"

          gcloud artifacts docker images copy $DEV_IMAGE $PROD_IMAGE_LATEST \
            --project="${{ env.PROD_PROJECT }}" \
            --quiet || echo "âš ï¸  Failed to copy latest tag"

          gcloud artifacts docker images copy $DEV_IMAGE $PROD_IMAGE_SHA \
            --project="${{ env.PROD_PROJECT }}" \
            --quiet || echo "âš ï¸  Failed to copy SHA tag"

          echo "âœ… Image copy completed"

      - name: Deploy to prod
        if: steps.params.outputs.environment == 'prod'
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          TAG_SHA=$(git rev-parse ${{ github.ref_name }})
          SHORT_SHA=$(git rev-parse --short $TAG_SHA)
          PROD_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROD_PROJECT }}/app-images/fashion-web:$SHORT_SHA"

          echo "ðŸš€ Deploying to production..."
          echo "   Version: $VERSION"
          echo "   Image: $PROD_IMAGE"

          gcloud run services update fashion-web \
            --image $PROD_IMAGE \
            --region="${{ env.REGION }}" \
            --project="${{ env.PROD_PROJECT }}" \
            --quiet

          echo "âœ… Production deployment complete"

  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        continue-on-error: true
        with:
          app-id: ${{ secrets.RELEASE_BOT_CLIENT_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}
          installation-id: ${{ secrets.RELEASE_BOT_INSTALLATION_ID }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Generate changelog and bump version
        id: release
        run: |
          export HUSKY=0 SKIP_COMMIT=true SKIP_TAG=true
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          COMMITS=$(if [ -n "$LAST_TAG" ]; then git log ${LAST_TAG}..HEAD --oneline --grep="^chore(release):" --invert-grep || echo ""; else git log --oneline --grep="^chore(release):" --invert-grep || echo ""; fi)
          if [ -z "$COMMITS" ]; then
            echo "needs_release=false" >> $GITHUB_ENV
            exit 0
          fi
          if echo "$COMMITS" | grep -qiE "BREAKING"; then
            npx standard-version --release-as major --skip.commit --skip.tag || true
          elif echo "$COMMITS" | grep -qiE "^[a-f0-9]+.*feat"; then
            npx standard-version --release-as minor --skip.commit --skip.tag || true
          else
            npx standard-version --release-as patch --skip.commit --skip.tag || true
          fi
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "needs_release=true" >> $GITHUB_ENV

      - name: Commit version and changelog
        if: env.needs_release == 'true'
        run: |
          git add package.json pnpm-lock.yaml CHANGELOG.md
          if ! git diff --staged --quiet; then
            git commit -m "chore(release): ${{ steps.release.outputs.version }}"
            git push origin main
            echo "âœ… Version and changelog committed"
          else
            echo "âš ï¸  No changes to commit"
            echo "needs_release=false" >> $GITHUB_ENV
          fi

      - name: Create and push git tag
        if: env.needs_release == 'true'
        run: |
          git tag -a "v${{ steps.release.outputs.version }}" -m "chore(release): ${{ steps.release.outputs.version }}"
          git push origin "v${{ steps.release.outputs.version }}"
          echo "âœ… Git tag v${{ steps.release.outputs.version }} created and pushed"

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event_name == 'push'
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ github.ref_type == 'tag' && 'projects/570865959950/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' || 'projects/635555941174/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' }}
          service_account: github-actions-deployer@${{ github.ref_type == 'tag' && env.PROD_PROJECT || env.DEV_PROJECT }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Health check
        run: |
          sleep 30
          SERVICE_NAME="${{ github.ref_type == 'tag' && 'fashion-web' || 'fashion-web-dev' }}"
          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
            --region="${{ env.REGION }}" \
            --project="${{ github.ref_type == 'tag' && env.PROD_PROJECT || env.DEV_PROJECT }}" \
            --format='value(status.url)' 2>/dev/null || echo "")
          if [ -z "$SERVICE_URL" ]; then
            exit 0
          fi
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SERVICE_URL" || echo "000")
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "301" ] && [ "$HTTP_CODE" != "302" ]; then
            exit 1
          fi
