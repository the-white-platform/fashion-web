name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  pull-requests: write

env:
  REGION: asia-southeast1
  DEV_PROJECT: the-white-dev-481217
  PROD_PROJECT: the-white-prod-481217

jobs:
  cancel-cloud-builds:
    name: Cancel Cloud Builds
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "project_id=${{ env.PROD_PROJECT }}" >> $GITHUB_OUTPUT
            echo "filter=source.repoSource.tagName=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "project_id=${{ env.DEV_PROJECT }}" >> $GITHUB_OUTPUT
            echo "filter=source.repoSource.branchName=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ steps.env.outputs.environment == 'prod' && 'projects/570865959950/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' || 'projects/635555941174/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' }}
          service_account: github-actions-deployer@${{ steps.env.outputs.project_id }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cancel previous builds
        run: |
          RUNNING_BUILDS=$(gcloud builds list \
            --region="${{ env.REGION }}" \
            --project="${{ steps.env.outputs.project_id }}" \
            --filter="status=WORKING OR status=QUEUED AND ${{ steps.env.outputs.filter }}" \
            --format="value(id)" \
            --limit=50 2>/dev/null || echo "")
          for BUILD_ID in $RUNNING_BUILDS; do
            gcloud builds cancel "$BUILD_ID" \
              --region="${{ env.REGION }}" \
              --project="${{ steps.env.outputs.project_id }}" \
              --quiet 2>/dev/null || true
          done

  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        if: github.event_name == 'pull_request'
        uses: actions/create-github-app-token@v1
        continue-on-error: true
        with:
          app-id: ${{ secrets.RELEASE_BOT_CLIENT_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}
          installation-id: ${{ secrets.RELEASE_BOT_INSTALLATION_ID }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Auto-fix formatting
        id: format
        run: |
          pnpm format || true
          if ! git diff --quiet; then
            git add -A
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit formatting fixes
        if: github.event_name == 'pull_request' && steps.format.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if ! git diff --staged --quiet; then
            git commit -m "style: auto-fix formatting issues" || exit 0
            git push origin HEAD:${{ github.head_ref }} || true
          fi

      - name: Verify formatting
        run: pnpm format:check

      - name: Run linter
        run: pnpm lint

      - name: Type check
        run: npx tsc --noEmit

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SERVER_URL: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'https://fashion-web-dev-XXXXXX.run.app' || 'http://localhost:3000' }}
          PAYLOAD_SECRET: dummy-secret-for-build
          DATABASE_URI: dummy-uri-for-build

  version-check:
    name: Version Check
    runs-on: ubuntu-latest
    needs: [quality, build]
    if: github.event_name == 'pull_request'
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        continue-on-error: true
        with:
          app-id: ${{ secrets.RELEASE_BOT_CLIENT_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}
          installation-id: ${{ secrets.RELEASE_BOT_INSTALLATION_ID }}

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check version
        run: |
          PR_VERSION=$(node -p "require('./package.json').version")
          MAIN_VERSION=$(git show origin/main:package.json 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync(0, 'utf-8')).version" || echo "0.0.0")
          COMPARISON=$(node -e "
            const pr = '$PR_VERSION'.split('.').map(Number);
            const main = '$MAIN_VERSION'.split('.').map(Number);
            for (let i = 0; i < 3; i++) {
              if (pr[i] > main[i]) { console.log('newer'); process.exit(0); }
              if (pr[i] < main[i]) { console.log('older'); process.exit(0); }
            }
            console.log('same');
          ")
          if [ "$COMPARISON" = "older" ]; then
            PR_MAJOR=$(echo "$PR_VERSION" | cut -d. -f1)
            if [ "$PR_MAJOR" != "0" ] || [ "$(echo "$MAIN_VERSION" | cut -d. -f1)" = "0" ]; then
              echo "âŒ PR version ($PR_VERSION) is older than main ($MAIN_VERSION)"
              exit 1
            fi
          fi

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build, cancel-cloud-builds]
    if: github.event_name == 'push'
    environment:
      name: ${{ github.ref_type == 'tag' && 'prod' || 'dev' }}
    steps:
      - name: Determine deployment parameters
        id: params
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "project_id=${{ env.PROD_PROJECT }}" >> $GITHUB_OUTPUT
            echo "service_name=fashion-web" >> $GITHUB_OUTPUT
            echo "service_account=github-actions-deployer@${{ env.PROD_PROJECT }}.iam.gserviceaccount.com" >> $GITHUB_OUTPUT
            echo "workload_identity_provider=projects/570865959950/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider" >> $GITHUB_OUTPUT
            echo "next_public_server_url=https://fashion-web-XXXXXX.run.app" >> $GITHUB_OUTPUT
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "project_id=${{ env.DEV_PROJECT }}" >> $GITHUB_OUTPUT
            echo "service_name=fashion-web-dev" >> $GITHUB_OUTPUT
            echo "service_account=github-actions-deployer@${{ env.DEV_PROJECT }}.iam.gserviceaccount.com" >> $GITHUB_OUTPUT
            echo "workload_identity_provider=projects/635555941174/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider" >> $GITHUB_OUTPUT
            echo "next_public_server_url=https://fashion-web-dev-XXXXXX.run.app" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ steps.params.outputs.workload_identity_provider }}
          service_account: ${{ steps.params.outputs.service_account }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_type == 'tag' && format('refs/tags/{0}', github.ref_name) || github.ref }}

      - name: Trigger Cloud Build
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [ "${{ github.ref_type }}" = "tag" ]; then
            TAG_FOR_BUILD=${GITHUB_REF_NAME#v}
            gcloud builds submit --config cloudbuild.yaml \
              --project "${{ steps.params.outputs.project_id }}" \
              --region="${{ env.REGION }}" \
              --substitutions _NEXT_PUBLIC_SERVER_URL="${{ steps.params.outputs.next_public_server_url }}",SHORT_SHA="$SHORT_SHA",TAG_NAME="$TAG_FOR_BUILD" \
              --git-source-tag="${{ github.ref_name }}"
          else
            gcloud builds submit --config cloudbuild.yaml \
              --project "${{ steps.params.outputs.project_id }}" \
              --region="${{ env.REGION }}" \
              --substitutions _NEXT_PUBLIC_SERVER_URL="${{ steps.params.outputs.next_public_server_url }}",SHORT_SHA="$SHORT_SHA" \
              --git-source-branch="${{ github.ref_name }}"
          fi

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        continue-on-error: true
        with:
          app-id: ${{ secrets.RELEASE_BOT_CLIENT_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}
          installation-id: ${{ secrets.RELEASE_BOT_INSTALLATION_ID }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Generate changelog and bump version
        id: release
        run: |
          export HUSKY=0 SKIP_COMMIT=true SKIP_TAG=true
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          COMMITS=$(if [ -n "$LAST_TAG" ]; then git log ${LAST_TAG}..HEAD --oneline --grep="^chore(release):" --invert-grep || echo ""; else git log --oneline --grep="^chore(release):" --invert-grep || echo ""; fi)
          if [ -z "$COMMITS" ]; then
            echo "needs_release=false" >> $GITHUB_ENV
            exit 0
          fi
          if echo "$COMMITS" | grep -qiE "BREAKING"; then
            npx standard-version --release-as major --skip.commit --skip.tag || true
          elif echo "$COMMITS" | grep -qiE "^[a-f0-9]+.*feat"; then
            npx standard-version --release-as minor --skip.commit --skip.tag || true
          else
            npx standard-version --release-as patch --skip.commit --skip.tag || true
          fi
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "needs_release=true" >> $GITHUB_ENV

      - name: Commit and tag
        if: env.needs_release == 'true'
        run: |
          git add package.json pnpm-lock.yaml CHANGELOG.md
          if ! git diff --staged --quiet; then
            git commit -m "chore(release): ${{ steps.release.outputs.version }}"
            git push origin main
            git tag -a "v${{ steps.release.outputs.version }}" -m "chore(release): ${{ steps.release.outputs.version }}"
            git push origin "v${{ steps.release.outputs.version }}"
          fi

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event_name == 'push'
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ github.ref_type == 'tag' && 'projects/570865959950/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' || 'projects/635555941174/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider' }}
          service_account: github-actions-deployer@${{ github.ref_type == 'tag' && env.PROD_PROJECT || env.DEV_PROJECT }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Health check
        run: |
          sleep 30
          SERVICE_NAME="${{ github.ref_type == 'tag' && 'fashion-web' || 'fashion-web-dev' }}"
          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
            --region="${{ env.REGION }}" \
            --project="${{ github.ref_type == 'tag' && env.PROD_PROJECT || env.DEV_PROJECT }}" \
            --format='value(status.url)' 2>/dev/null || echo "")
          if [ -z "$SERVICE_URL" ]; then
            exit 0
          fi
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SERVICE_URL" || echo "000")
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "301" ] && [ "$HTTP_CODE" != "302" ]; then
            exit 1
          fi
